{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="flex flex-col gap-2">
  <p class="text-xs font-semibold uppercase tracking-[0.4em] text-slate-500">Visao Geral</p>
  <h2 class="font-display text-3xl">Atendimento</h2>
  <p class="max-w-2xl text-sm text-slate-600">
    Centro de Monitoramento Para Prestação de Serviços.
  </p>
</div>

<div class="mt-10 grid gap-6 {% if is_gestor %}lg:grid-cols-2{% else %}grid-cols-1{% endif %}">
  {% if is_gestor %}
  <div class="rounded-3xl border border-slate-200/70 bg-white/80 p-6 shadow-soft">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-xs font-semibold uppercase tracking-[0.3em] text-emerald-500">Aparelhos</p>
        <h3 class="mt-2 text-xl font-semibold">Aparelhos</h3>
      </div>
      <a href="{% url 'novo_aparelho' %}" class="rounded-full bg-emerald-500 px-4 py-2 text-xs font-semibold text-white transition hover:-translate-y-0.5">
        + Novo Aparelho
      </a>
    </div>

    <div class="mt-6 space-y-4">
      {% for a in aparelhos %}
      <div class="flex flex-wrap items-center justify-between gap-3 rounded-2xl border border-slate-200 bg-white px-4 py-3">
        <div>
          <p class="font-semibold text-slate-900">{{ a.nome }}</p>
          <p class="text-xs text-slate-500">{{ a.marca }} · {{ a.modelo }}</p>
          <p class="text-xs text-slate-400">Cliente: {{ a.cliente }}</p>
        </div>
        <div class="flex items-center gap-2">
          <a href="{% url 'nova_os' a.id %}" class="rounded-full border border-emerald-200 bg-emerald-50 px-3 py-1 text-xs font-semibold text-emerald-700">
            Criar OS
          </a>
          <a href="{% url 'editar_aparelho' a.id %}" class="rounded-full border border-slate-200 px-3 py-1 text-xs font-semibold text-slate-600">
            Editar
          </a>
        </div>
      </div>
      {% empty %}
      <p class="rounded-2xl border border-dashed border-slate-200 bg-white/60 px-4 py-6 text-sm text-slate-500">
        Nenhum aparelho cadastrado ainda.
      </p>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <div class="rounded-3xl border border-slate-200/70 bg-white/80 p-6 shadow-soft">
    <div class="flex flex-wrap items-center justify-between gap-3">
      <div>
        <p class="text-xs font-semibold uppercase tracking-[0.3em] text-sky-500">Serviços</p>
        <h3 class="mt-2 text-xl font-semibold">Ordens de Servico</h3>
      </div>
      <span class="rounded-full border border-slate-200 bg-white px-3 py-1 text-xs font-semibold text-slate-500">
        {{ ordens|length }} registros
      </span>
    </div>

    <form method="get" class="mt-6 grid gap-3 rounded-2xl border border-slate-200 bg-white/70 p-4 sm:grid-cols-2 lg:grid-cols-4">
      <div class="sm:col-span-2 lg:col-span-2">
        <label class="form-label">Busca</label>
        <input
          type="text"
          name="q"
          value="{{ filters.q }}"
          class="form-control"
          placeholder="OS, aparelho, cliente ou problema"
        >
      </div>
      <div>
        <label class="form-label">Status</label>
        <select name="status" class="form-select">
          <option value="">Todos</option>
          {% for value, label in status_choices %}
          <option value="{{ value }}" {% if filters.status == value %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label class="form-label">Prioridade</label>
        <select name="prioridade" class="form-select">
          <option value="">Todas</option>
          {% for value, label in prioridade_choices %}
          <option value="{{ value }}" {% if filters.prioridade == value %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      {% if is_gestor %}
      <div class="sm:col-span-2 lg:col-span-2">
        <label class="form-label">Tecnico</label>
        <select name="tecnico" class="form-select">
          <option value="">Todos</option>
          {% for t in tecnicos %}
          <option value="{{ t.id }}" {% if filters.tecnico == t.id|stringformat:"s" %}selected{% endif %}>
            {{ t }}
          </option>
          {% endfor %}
        </select>
      </div>
      {% endif %}
      <div class="flex items-end gap-2 sm:col-span-2 lg:col-span-2">
        <button type="submit" class="rounded-2xl bg-slate-900 px-5 py-3 text-sm font-semibold text-white transition hover:-translate-y-0.5">
          Filtrar
        </button>
        <a href="{% url 'home' %}" class="rounded-2xl bg-red-900 px-3 py-2 text-sm font-semibold text-white transition hover:-translate-y-0.5">
          Limpar
        </a>
      </div>
    </form>

    <div class="mt-6 space-y-4">
      {% for os in ordens %}
      <div class="rounded-2xl border border-slate-200 bg-white px-4 py-4">
        <div class="flex flex-wrap items-start justify-between gap-3">
          <div>
            <p class="text-sm font-semibold text-slate-900">OS #{{ os.id }}</p>
            <p class="text-xs text-slate-500">
              {{ os.aparelho.nome }} · {{ os.aparelho.marca }} {{ os.aparelho.modelo }} · {{ os.aparelho.cliente }}
            </p>
          </div>
          <div class="flex flex-col items-end gap-2">
            <span class="rounded-full bg-slate-900 px-3 py-1 text-xs font-semibold text-white">{{ os.status }}</span>
            {% if os.is_atrasada %}
            <span class="rounded-full bg-rose-100 px-3 py-1 text-[10px] font-semibold text-rose-700">
              Atrasada
            </span>
            {% endif %}
            {% if os.funcionario and funcionario and os.funcionario.id == funcionario.id and os.status == "AGENDADO" %}
            <div class="flex items-center gap-2 text-[11px] font-semibold">
              <button
                type="button"
                data-modal-target="aprovar-modal-{{ os.id }}"
                data-modal-toggle="aprovar-modal-{{ os.id }}"
                class="rounded-full border border-emerald-200 bg-emerald-50 px-3 py-1 text-emerald-700"
              >
                Aceitar
              </button>
              <button
                type="button"
                data-modal-target="aprovar-modal-{{ os.id }}"
                data-modal-toggle="aprovar-modal-{{ os.id }}"
                class="rounded-full border border-rose-200 bg-rose-50 px-3 py-1 text-rose-700"
              >
                Rejeitar
              </button>
            </div>
            {% endif %}
          </div>
        </div>

        <div class="mt-4 flex flex-wrap items-center gap-2 text-xs font-semibold text-slate-600">
          <a href="{% url 'detalhe_os' os.id %}" class="rounded-full border border-slate-200 px-3 py-1 transition hover:border-slate-400">
            Ver detalhes
          </a>
          {% if funcionario and os.funcionario_id == funcionario.id %}
          <a href="{% url 'registrar_manutencao_os' os.id %}" class="rounded-full border border-amber-200 bg-amber-50 px-3 py-1 text-amber-700">
            Registrar manutencao
          </a>
          {% endif %}
          {% if is_gestor and os.status != "CONCLUIDO" %}
          <a href="{% url 'designar_funcionario' os.id %}" class="rounded-full border border-sky-200 bg-sky-50 px-3 py-1 text-sky-700">
            Designar tecnico
          </a>
          {% endif %}
          {% if is_gestor and os.status == "EM_ANDAMENTO" %}
          <a href="{% url 'finalizar_os' os.id %}" class="rounded-full border border-rose-200 bg-rose-50 px-3 py-1 text-rose-700">
            Finalizar OS
          </a>
          {% endif %}
        </div>
      </div>
      {% empty %}
      <p class="rounded-2xl border border-dashed border-slate-200 bg-white/60 px-4 py-6 text-sm text-slate-500">
        Nenhuma ordem criada ainda.
      </p>
      {% endfor %}
    </div>
  </div>
</div>
{% endblock %}

{% block modals %}
  {% for os in ordens %}
    {% if os.funcionario and funcionario and os.funcionario.id == funcionario.id and os.status == "AGENDADO" %}
    <div
      id="aprovar-modal-{{ os.id }}"
      tabindex="-1"
      aria-hidden="true"
      class="fixed left-0 right-0 top-0 z-[100] hidden h-[calc(100%-1rem)] max-h-full w-full items-center justify-center overflow-y-auto overflow-x-hidden p-4 md:inset-0"
    >
      <div class="relative max-h-full w-full max-w-md">
        <div class="relative rounded-3xl border border-slate-200 bg-white p-6 shadow-soft">
          <div class="mb-4">
            <p class="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">Confirmacao</p>
            <h3 class="mt-2 font-display text-xl">Aceitar ou rejeitar OS</h3>
            <p class="text-sm text-slate-500">OS #{{ os.id }} · {{ os.aparelho.nome }}</p>
          </div>
          <form method="post" action="{% url 'decidir_os' os.id %}" class="flex flex-wrap items-center gap-3">
            {% csrf_token %}
            <button
              type="submit"
              name="acao"
              value="aceitar"
              class="rounded-2xl bg-emerald-500 px-4 py-2 text-xs font-semibold text-white"
            >
              Aceitar
            </button>
            <button
              type="submit"
              name="acao"
              value="rejeitar"
              class="rounded-2xl bg-rose-500 px-4 py-2 text-xs font-semibold text-white"
            >
              Rejeitar
            </button>
            <button
              type="button"
              data-modal-hide="aprovar-modal-{{ os.id }}"
              class="text-xs font-semibold text-slate-600 hover:text-slate-900"
            >
              Cancelar
            </button>
          </form>
        </div>
      </div>
    </div>
    {% endif %}
  {% endfor %}
{% endblock %}
